<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekap Pick</title>
    <style>
        /* Style untuk body agar tampil di tengah dan responsif */
        body {
            font-family: 'Poppins', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #e0e0e0;
            transition: background-color 0.5s ease;
        }

        /* Style utama untuk container */
        .container {
            max-width: 400px;
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            padding: 30px;
            text-align: center;
            background-color: white;
            transition: background-color 0.5s ease, color 0.5s ease;
            position: relative;
        }

        h2 {
            margin-bottom: 20px;
            font-size: 28px;
            color: #333;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: fadeIn 0.5s ease;
        }

        /* Animasi untuk judul */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        textarea, input[type="text"], input[type="number"], select {
            width: calc(100% - 20px);
            padding: 12px;
            font-size: 16px;
            border-radius: 10px;
            border: 1px solid #ccc;
            margin-bottom: 15px;
            background-color: #fafafa;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        textarea:focus, input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #007bff;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
            outline: none;
        }

        button {
            width: 100%;
            background-color: #007bff;
            color: white;
            padding: 15px;
            font-size: 18px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            font-weight: bold;
        }

        button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        #alert {
            color: red;
            font-size: 14px;
        }

        #mainContainer {
            display: none;
        }

        /* Gaya untuk owner */
        #ownerContainer {
            display: none;
        }

        .result {
            margin-top: 20px;
            text-align: left;
            display: flex;
            flex-direction: column; /* Align results in a column */
            gap: 10px; /* Space between each result item */
        }

        .result-item {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            color: #555;
            transition: background-color 0.3s ease;
        }

        .result-item:hover {
            background-color: #e2e2e2;
        }
    </style>
</head>
<body>

<div class="container" id="keyInputContainer">
    <h2>Masukkan Nomor Telepon</h2>
    <input type="text" id="phoneNumberInput" placeholder="Masukkan nomor telepon">
    <button id="submitButton">Submit Nomor</button>
    <p id="alert"></p>
    <p id="displayPhoneNumber"></p>
</div>

<div class="container" id="mainContainer">
    <h2>Rekap Pick</h2>

    <!-- Owner bisa menambahkan langganan baru -->
    <div id="ownerContainer">
        <h3>Tambah Langganan Baru</h3>
        <input type="number" id="subscriptionDays" placeholder="Durasi Langganan (hari)" min="1">
        <button onclick="addRandomSubscription()">Tambah Langganan Baru</button>
        <p id="newUserAlert"></p>
    </div>

    <select id="themeSelector" class="theme-selector" onchange="changeTheme()">
        <option value="modern">Modern</option>
        <option value="futuristic">Futuristic</option>
        <option value="tradisional">Tradisional</option>
        <option value="hitam-putih">Hitam-Putih</option>
    </select>

    <textarea id="inputText" rows="5" placeholder="Masukkan list"></textarea>
    <input type="number" id="perkalianInput" placeholder="Masukkan nilai perkalian (Ã—)">
    <input type="number" id="persentaseInput" placeholder="Masukkan persentase (%)">

    <button id="calculateButton" onclick="hitung()">Hitung</button>

    <div class="result" id="resultContainer"></div>
</div>

<script>
// Data owners dan users dari JSON
const database = {
  "owners": [
    {
      "phoneNumber": "1234567890",
      "isOwner": true
    }
  ],
  "users": [
    {
      "phoneNumber": "0987654321",
      "isPermanent": true
    },
    {
      "phoneNumber": "628560780",
      "isPermanent": false,
      "subscriptionStart": "2024-01-01",
      "subscriptionDays": 30
    }
  ]
};

let userDatabase = database.users;
let ownerDatabase = database.owners;

// Tunggu sampai DOM siap sebelum menambahkan event listener
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('submitButton').addEventListener('click', checkSubscription);
});

function normalizePhoneNumber(phoneNumber) {
    return phoneNumber.replace(/\D/g, ''); // Hapus karakter non-numerik
}

function checkSubscription() {
    let phoneNumber = document.getElementById('phoneNumberInput').value.trim();
    phoneNumber = normalizePhoneNumber(phoneNumber); // Normalisasi nomor telepon

    const owner = ownerDatabase.find(owner => normalizePhoneNumber(owner.phoneNumber) === phoneNumber);
    if (owner) {
        document.getElementById('ownerContainer').style.display = 'block';
        document.getElementById('mainContainer').style.display = 'block';
        document.getElementById('keyInputContainer').style.display = 'none';
    } else {
        const user = userDatabase.find(user => normalizePhoneNumber(user.phoneNumber) === phoneNumber);
        if (user) {
            document.getElementById('keyInputContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        } else {
            document.getElementById('alert').innerText = 'Nomor tidak ditemukan dalam database.';
        }
    }
}

async function addRandomSubscription() {
    const subscriptionDays = parseInt(document.getElementById('subscriptionDays').value);
    if (!subscriptionDays || subscriptionDays < 1) {
        document.getElementById('newUserAlert').innerText = 'Durasi harus lebih dari 0 hari.';
        return;
    }

    const randomPhoneNumber = '62' + Math.floor(Math.random() * 1000000000); // Buat nomor acak
    if (!userDatabase.some(user => user.phoneNumber === randomPhoneNumber)) {
        const newUser = {
            phoneNumber: randomPhoneNumber,
            isPermanent: false,
            subscriptionStart: new Date().toISOString().split('T')[0],
            subscriptionDays: subscriptionDays
        };

        userDatabase.push(newUser);
        document.getElementById('newUserAlert').innerText = `Langganan baru berhasil ditambahkan: ${randomPhoneNumber} dengan durasi ${subscriptionDays} hari.`;
        
        // Update the GitHub repository
        await updateGitHubDatabase(userDatabase);
    } else {
        document.getElementById('newUserAlert').innerText = `Nomor sudah ada di database.`;
    }
}

<script>
async function addRandomSubscription() {
    const subscriptionDays = parseInt(document.getElementById('subscriptionDays').value);
    if (!subscriptionDays || subscriptionDays < 1) {
        document.getElementById('newUserAlert').innerText = 'Durasi harus lebih dari 0 hari.';
        return;
    }

    const randomPhoneNumber = '62' + Math.floor(Math.random() * 1000000000); // Buat nomor acak
    if (!userDatabase.some(user => user.phoneNumber === randomPhoneNumber)) {
        const newUser = {
            phoneNumber: randomPhoneNumber,
            isPermanent: false,
            subscriptionStart: new Date().toISOString().split('T')[0],
            subscriptionDays: subscriptionDays
        };

        userDatabase.push(newUser);
        document.getElementById('newUserAlert').innerText = `Langganan baru berhasil ditambahkan: ${randomPhoneNumber} dengan durasi ${subscriptionDays} hari.`;
        
        // Update the GitHub repository
        await updateGitHubDatabase(userDatabase);
    } else {
        document.getElementById('newUserAlert').innerText = `Nomor sudah ada di database.`;
    }
}

async function updateGitHubDatabase(updatedDatabase) {
    const token = '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'; // Ganti dengan token Anda
    const repoOwner = 'ryugn1'; // Ganti dengan username GitHub Anda
    const repoName = 'ryugn1.github.io'; // Ganti dengan nama repositori Anda
    const filePath = 'index.html'; // Path ke file HTML di repositori Anda

    // Dapatkan konten file saat ini
    const currentContent = await fetchCurrentFileContent(filePath, repoOwner, repoName, token);
    if (!currentContent) return; // Jika gagal mendapatkan konten, keluar dari fungsi

    // Cari bagian database di dalam file HTML (gunakan regex untuk mengambil block database dari <script>)
    const dbRegex = /<script>\s*const database = (\{.*?\});\s*<\/script>/s;
    const match = currentContent.match(dbRegex);

    if (match) {
        const updatedDatabaseContent = JSON.stringify({ users: updatedDatabase, owners: database.owners }, null, 2); // Format JSON
        const updatedContent = currentContent.replace(dbRegex, `<script>\nconst database = ${updatedDatabaseContent};\n</script>`); // Ganti database lama dengan yang baru

        // Update konten di GitHub
        const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: 'Update database with new subscription',
                content: btoa(updatedContent), // Encode konten yang diperbarui ke base64
                sha: await getFileSHA(filePath, repoOwner, repoName, token) // Ambil SHA file saat ini
            })
        });

        if (response.ok) {
            console.log('Database updated successfully.');
        } else {
            console.error('Error updating database:', await response.json());
        }
    } else {
        console.error("Database block not found in the file.");
    }
}

async function getFileSHA(filePath, repoOwner, repoName, token) {
    const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
        headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
        }
    });
    
    const data = await response.json();
    return data.sha; // Kembalikan SHA file saat ini
}

async function fetchCurrentFileContent(filePath, repoOwner, repoName, token) {
    const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`, {
        headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json',
        }
    });

    if (!response.ok) {
        console.error('Error fetching file content:', await response.json());
        return null; // Jika gagal, kembalikan null
    }
    
    const data = await response.json();
    return atob(data.content); // Decode konten dari base64
}

function hitung() {
    const inputText = document.getElementById('inputText').value;
    const perkalian = parseFloat(document.getElementById('perkalianInput').value);
    const persentase = parseFloat(document.getElementById('persentaseInput').value);
    const inputList = inputText.split('\n');
    const resultContainer = document.getElementById('resultContainer');
    resultContainer.innerHTML = ''; // Clear previous results

    inputList.forEach(item => {
        const angkaAwal = item.match(/(\d+)/);
        if (angkaAwal) {
            const angka = parseInt(angkaAwal[0]);
            const hasilPerkalian = angka * perkalian; // Hasil dari perkalian
            const hasil = hasilPerkalian - (persentase / 100) * hasilPerkalian; // Kurangi dengan persentase dari hasil perkalian
            const resultItem = document.createElement('div');
            resultItem.classList.add('result-item');
            resultItem.innerText = `${item.trim()} / ${formatNumber(hasil)}`;
            resultContainer.appendChild(resultItem); // Append each result item
        }
    });
}

// Fungsi untuk format angka dengan titik sebagai pemisah ribuan
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".").replace(/\.0+$/, "");
}

function changeTheme() {
    const selectedTheme = document.getElementById('themeSelector').value;
    const container = document.querySelectorAll('.container');
    container.forEach(cont => {
        cont.className = 'container ' + selectedTheme;
    });

    // Changing background color for body smoothly
    const body = document.body;
    switch (selectedTheme) {
        case 'modern':
            body.style.backgroundColor = '#e0e0e0';
            break;
        case 'futuristic':
            body.style.backgroundColor = '#1d1f27';
            break;
        case 'tradisional':
            body.style.backgroundColor = '#fff8e1';
            break;
        case 'hitam-putih':
            body.style.backgroundColor = '#000';
            break;
        default:
            body.style.backgroundColor = '#e0e0e0';
    }
}
</script>
</body>
</html>
